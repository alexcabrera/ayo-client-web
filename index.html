<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d1117" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <title>ayo</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent: #58a6ff;
            --accent-subtle: #388bfd26;
            --border: #30363d;
            --success: #3fb950;
            --error: #f85149;
            --warning: #d29922;
            --user-bg: #1f6feb;
            --assistant-bg: #21262d;
            --tool-bg: #161b22;
            --reasoning-bg: #1c1c1c;
            --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --radius: 8px;
            --radius-sm: 4px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #ffffff;
                --bg-secondary: #f6f8fa;
                --bg-tertiary: #eaeef2;
                --text-primary: #1f2328;
                --text-secondary: #656d76;
                --text-muted: #8c959f;
                --accent: #0969da;
                --accent-subtle: #ddf4ff;
                --border: #d0d7de;
                --success: #1a7f37;
                --error: #cf222e;
                --warning: #9a6700;
                --user-bg: #ddf4ff;
                --assistant-bg: #f6f8fa;
                --tool-bg: #f6f8fa;
                --reasoning-bg: #f0f0f0;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            height: 100%;
            font-family: var(--font-sans);
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--bg-primary);
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        /* Prevent pull-to-refresh and overscroll */
        body {
            overscroll-behavior: none;
        }

        /* Connection Screen */
        .connect-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 2rem;
            padding-top: calc(2rem + var(--safe-top));
            padding-bottom: calc(2rem + var(--safe-bottom));
        }

        .connect-screen.hidden {
            display: none;
        }

        .connect-logo {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .connect-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .connect-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 320px;
        }

        .connect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.15s;
            touch-action: manipulation;
            min-height: 48px;
        }

        .connect-btn:hover {
            opacity: 0.9;
        }

        .connect-btn:active {
            opacity: 0.8;
        }

        .connect-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .connect-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .connect-divider::before,
        .connect-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .connect-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }

        .connect-form input {
            padding: 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 16px; /* Prevents iOS zoom */
            min-height: 48px;
        }

        .connect-form input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .connect-form input::placeholder {
            color: var(--text-muted);
        }

        .connect-error {
            color: var(--error);
            font-size: 0.875rem;
            text-align: center;
        }

        /* QR Scanner Modal */
        .scanner-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
        }

        .scanner-modal.hidden {
            display: none;
        }

        .scanner-container {
            position: relative;
            width: min(300px, 80vw);
            height: min(300px, 80vw);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            inset: 0;
            border: 3px solid var(--accent);
            border-radius: var(--radius);
            pointer-events: none;
        }

        .scanner-hint {
            margin-top: 1.5rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 0 1rem;
        }

        .scanner-close {
            margin-top: 1rem;
            padding: 0.75rem 2rem;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            min-height: 48px;
            touch-action: manipulation;
        }

        /* App Layout */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .app.hidden {
            display: none;
        }

        /* Desktop sidebar layout */
        @media (min-width: 769px) {
            .app {
                display: grid;
                grid-template-columns: 260px 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .header {
                grid-column: 1 / -1;
            }
            
            .sidebar {
                display: flex !important;
            }
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            padding-top: calc(0.75rem + var(--safe-top));
            padding-left: calc(1rem + var(--safe-left));
            padding-right: calc(1rem + var(--safe-right));
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            min-height: 56px;
            flex-shrink: 0;
        }

        .menu-btn {
            display: none;
            padding: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            touch-action: manipulation;
        }

        @media (max-width: 768px) {
            .menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        .header h1 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header .agent-select {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 16px; /* Prevents iOS zoom */
            cursor: pointer;
            max-width: 150px;
            min-height: 40px;
        }

        .header .status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            flex-shrink: 0;
        }

        .header .status-dot.connected {
            background: var(--success);
        }

        .header .status-dot.error {
            background: var(--error);
        }

        .header .status-text {
            display: none;
        }

        @media (min-width: 400px) {
            .header .status-text {
                display: inline;
            }
        }

        .header .disconnect-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 40px;
        }

        .header .disconnect-btn:hover {
            background: var(--bg-tertiary);
        }

        /* Sidebar */
        .sidebar {
            display: none;
            flex-direction: column;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow: hidden;
        }

        .sidebar.open {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            z-index: 100;
            padding-top: var(--safe-top);
            padding-left: var(--safe-left);
            padding-bottom: var(--safe-bottom);
        }

        .sidebar-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-backdrop.visible {
            display: block;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sidebar-close {
            display: none;
            padding: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .sidebar-close {
                display: block;
            }
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            -webkit-overflow-scrolling: touch;
        }

        .session-item {
            padding: 0.75rem;
            margin-bottom: 2px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.15s;
            touch-action: manipulation;
        }

        .session-item:hover {
            background: var(--bg-tertiary);
        }

        .session-item:active {
            background: var(--bg-tertiary);
        }

        .session-item.active {
            background: var(--accent-subtle);
        }

        .session-item .title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-item .meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .new-session-btn {
            margin: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.15s;
            touch-action: manipulation;
            min-height: 48px;
        }

        .new-session-btn:hover {
            opacity: 0.9;
        }

        /* Chat area */
        .chat {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-left: calc(1rem + var(--safe-left));
            padding-right: calc(1rem + var(--safe-right));
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 90%;
        }

        @media (min-width: 600px) {
            .message {
                max-width: 80%;
            }
        }

        .message.user {
            margin-left: auto;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user .message-content {
            background: var(--user-bg);
            color: white;
        }

        @media (prefers-color-scheme: light) {
            .message.user .message-content {
                color: var(--text-primary);
            }
        }

        .message.assistant .message-content {
            background: var(--assistant-bg);
            border: 1px solid var(--border);
        }

        .message pre {
            background: var(--bg-primary);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.8125rem;
            margin: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
        }

        .message code {
            font-family: var(--font-mono);
            font-size: 0.875em;
            background: var(--bg-tertiary);
            padding: 0.125rem 0.375rem;
            border-radius: var(--radius-sm);
        }

        .message pre code {
            background: none;
            padding: 0;
        }

        /* Tool calls */
        .tool-call {
            margin: 0.75rem 0;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .tool-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--tool-bg);
            border-bottom: 1px solid var(--border);
            font-size: 0.8125rem;
        }

        .tool-header .name {
            font-weight: 600;
            color: var(--accent);
        }

        .tool-header .description {
            color: var(--text-secondary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tool-header .duration {
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        .tool-header .status-icon {
            font-size: 0.875rem;
        }

        .tool-header .status-icon.success {
            color: var(--success);
        }

        .tool-header .status-icon.error {
            color: var(--error);
        }

        .tool-header .status-icon.pending {
            color: var(--warning);
        }

        .tool-body {
            padding: 0.75rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
            -webkit-overflow-scrolling: touch;
        }

        .tool-body.error {
            color: var(--error);
        }

        /* Reasoning */
        .reasoning {
            margin: 0.5rem 0;
            border-left: 2px solid var(--border);
            padding-left: 0.75rem;
        }

        .reasoning-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            touch-action: manipulation;
        }

        .reasoning-header:hover {
            color: var(--text-secondary);
        }

        .reasoning-content {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-style: italic;
            padding: 0.5rem 0;
            display: none;
        }

        .reasoning.expanded .reasoning-content {
            display: block;
        }

        /* Input area */
        .input-area {
            padding: 0.75rem 1rem;
            padding-bottom: calc(0.75rem + var(--safe-bottom));
            padding-left: calc(1rem + var(--safe-left));
            padding-right: calc(1rem + var(--safe-right));
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 16px; /* Prevents iOS zoom */
            resize: none;
            min-height: 44px;
            max-height: 120px;
            line-height: 1.4;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-container textarea::placeholder {
            color: var(--text-muted);
        }

        .input-container button {
            padding: 0.75rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.15s;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 60px;
        }

        .input-container button:hover:not(:disabled) {
            opacity: 0.9;
        }

        .input-container button:active:not(:disabled) {
            opacity: 0.8;
        }

        .input-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Streaming indicator */
        .streaming-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 4px;
        }

        .streaming-indicator span {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite;
        }

        .streaming-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .streaming-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .empty-state h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state p {
            max-width: 300px;
        }
    </style>
</head>
<body>
    <!-- Connection Screen -->
    <div class="connect-screen" id="connectScreen">
        <div class="connect-logo">ayo</div>
        <div class="connect-subtitle">Connect to your terminal</div>
        
        <div class="connect-options">
            <button class="connect-btn" id="scanQRBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                </svg>
                Scan QR Code
            </button>
            
            <div class="connect-divider">or enter manually</div>
            
            <div class="connect-form">
                <input type="url" id="serverUrl" placeholder="Server URL (e.g., https://xxx.trycloudflare.com)" autocapitalize="off" autocorrect="off">
                <input type="text" id="authToken" placeholder="Token (from ayo serve output)" autocapitalize="off" autocorrect="off">
                <button class="connect-btn secondary" id="connectBtn">Connect</button>
            </div>
            
            <div class="connect-error" id="connectError"></div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="scanner-modal hidden" id="scannerModal">
        <div class="scanner-container">
            <video id="scannerVideo" autoplay playsinline></video>
            <div class="scanner-overlay"></div>
        </div>
        <div class="scanner-hint">Point camera at QR code displayed by<br><code>ayo serve</code></div>
        <button class="scanner-close" id="closeScannerBtn">Cancel</button>
    </div>

    <!-- Sidebar Backdrop (mobile) -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- Main App -->
    <div class="app hidden" id="mainApp">
        <header class="header">
            <button class="menu-btn" id="menuBtn" aria-label="Open menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            <h1>ayo</h1>
            <select class="agent-select" id="agentSelect">
                <option value="">Loading...</option>
            </select>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span class="status-text" id="statusText">Connected</span>
            </div>
            <button class="disconnect-btn" id="disconnectBtn">Disconnect</button>
        </header>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Sessions</h2>
                <button class="sidebar-close" id="sidebarClose" aria-label="Close menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="session-list" id="sessionList"></div>
            <button class="new-session-btn" id="newSessionBtn">New Chat</button>
        </aside>

        <main class="chat">
            <div class="messages" id="messages">
                <div class="empty-state" id="emptyState">
                    <h2>Start a conversation</h2>
                    <p>Select an agent and type a message to begin.</p>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type a message..." 
                        rows="1"
                        autocapitalize="sentences"
                        autocorrect="on"
                    ></textarea>
                    <button id="sendBtn" disabled>Send</button>
                </div>
            </div>
        </main>
    </div>

    <!-- QR Code scanning library (jsQR - pure JS, no WASM) -->
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        // Connection state
        let API_BASE = '';
        let AUTH_TOKEN = '';
        let currentAgent = '';
        let currentSessionId = null;
        let isStreaming = false;

        // DOM elements
        const connectScreen = document.getElementById('connectScreen');
        const scannerModal = document.getElementById('scannerModal');
        const mainApp = document.getElementById('mainApp');
        const scanQRBtn = document.getElementById('scanQRBtn');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        const scannerVideo = document.getElementById('scannerVideo');
        const serverUrlInput = document.getElementById('serverUrl');
        const authTokenInput = document.getElementById('authToken');
        const connectBtn = document.getElementById('connectBtn');
        const connectError = document.getElementById('connectError');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const agentSelect = document.getElementById('agentSelect');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const sessionList = document.getElementById('sessionList');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const messagesContainer = document.getElementById('messages');
        const emptyState = document.getElementById('emptyState');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');
        const sidebarClose = document.getElementById('sidebarClose');

        // Mobile sidebar handling
        menuBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarBackdrop.classList.add('visible');
        });

        function closeSidebar() {
            sidebar.classList.remove('open');
            sidebarBackdrop.classList.remove('visible');
        }

        sidebarClose.addEventListener('click', closeSidebar);
        sidebarBackdrop.addEventListener('click', closeSidebar);

        // Check for saved connection
        function checkSavedConnection() {
            const saved = localStorage.getItem('ayo_connection');
            if (saved) {
                try {
                    const { url, token } = JSON.parse(saved);
                    serverUrlInput.value = url;
                    authTokenInput.value = token;
                } catch (e) {}
            }
            
            // If opened from server, try same-origin
            if (window.location.protocol !== 'file:') {
                API_BASE = window.location.origin;
                tryConnect();
            }
        }

        // QR Code scanning
        scanQRBtn.addEventListener('click', startQRScanner);
        closeScannerBtn.addEventListener('click', stopQRScanner);

        async function startQRScanner() {
            scannerModal.classList.remove('hidden');
            connectError.textContent = '';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                scannerVideo.srcObject = stream;
                await scannerVideo.play();
                
                // Use jsQR for scanning
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                const scanFrame = () => {
                    if (scannerModal.classList.contains('hidden')) {
                        return;
                    }
                    
                    if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
                        canvas.width = scannerVideo.videoWidth;
                        canvas.height = scannerVideo.videoHeight;
                        ctx.drawImage(scannerVideo, 0, 0);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        
                        if (code) {
                            handleQRResult(code.data);
                            return;
                        }
                    }
                    
                    requestAnimationFrame(scanFrame);
                };
                
                requestAnimationFrame(scanFrame);
                
            } catch (err) {
                console.error('Camera error:', err);
                connectError.textContent = 'Camera access denied. Please enter details manually.';
                stopQRScanner();
            }
        }

        function stopQRScanner() {
            scannerModal.classList.add('hidden');
            if (scannerVideo.srcObject) {
                scannerVideo.srcObject.getTracks().forEach(track => track.stop());
                scannerVideo.srcObject = null;
            }
        }

        function handleQRResult(result) {
            stopQRScanner();
            
            try {
                const data = JSON.parse(result);
                if (data.url && data.token) {
                    serverUrlInput.value = data.url;
                    authTokenInput.value = data.token;
                    connect();
                } else {
                    connectError.textContent = 'Invalid QR code format';
                }
            } catch (e) {
                connectError.textContent = 'Could not parse QR code';
            }
        }

        // Manual connection
        connectBtn.addEventListener('click', connect);
        serverUrlInput.addEventListener('keydown', e => e.key === 'Enter' && authTokenInput.focus());
        authTokenInput.addEventListener('keydown', e => e.key === 'Enter' && connect());

        async function connect() {
            const url = serverUrlInput.value.trim().replace(/\/$/, '');
            const token = authTokenInput.value.trim();
            
            if (!url) {
                connectError.textContent = 'Please enter a server URL';
                return;
            }
            
            API_BASE = url;
            AUTH_TOKEN = token;
            
            await tryConnect();
        }

        async function tryConnect() {
            connectError.textContent = '';
            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';
            
            try {
                const response = await fetchWithAuth('/health');
                if (!response.ok) {
                    throw new Error('Server not responding');
                }
                
                // Save connection
                localStorage.setItem('ayo_connection', JSON.stringify({
                    url: API_BASE,
                    token: AUTH_TOKEN
                }));
                
                // Switch to main app
                connectScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                await init();
                
            } catch (err) {
                connectError.textContent = err.message || 'Connection failed';
                API_BASE = '';
                AUTH_TOKEN = '';
            } finally {
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect';
            }
        }

        function fetchWithAuth(path, options = {}) {
            const headers = options.headers || {};
            if (AUTH_TOKEN) {
                headers['Authorization'] = `Bearer ${AUTH_TOKEN}`;
            }
            return fetch(`${API_BASE}${path}`, { ...options, headers });
        }

        // Disconnect
        disconnectBtn.addEventListener('click', () => {
            localStorage.removeItem('ayo_connection');
            API_BASE = '';
            AUTH_TOKEN = '';
            mainApp.classList.add('hidden');
            connectScreen.classList.remove('hidden');
            connectError.textContent = '';
        });

        // Initialize app
        async function init() {
            try {
                await loadAgents();
                await loadSessions();
                setStatus('connected', 'Connected');
            } catch (err) {
                setStatus('error', 'Connection failed');
                console.error('Init failed:', err);
            }

            // Event listeners
            agentSelect.addEventListener('change', onAgentChange);
            newSessionBtn.addEventListener('click', () => {
                startNewSession();
                closeSidebar();
            });
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', onInputKeydown);
            messageInput.addEventListener('input', autoResizeInput);
        }

        // Load available agents
        async function loadAgents() {
            const response = await fetchWithAuth('/agents');
            if (!response.ok) throw new Error('Failed to load agents');
            
            const agents = await response.json();
            agentSelect.innerHTML = '';
            
            if (agents.length === 0) {
                agentSelect.innerHTML = '<option value="">No agents</option>';
                return;
            }

            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.handle;
                option.textContent = agent.handle;
                agentSelect.appendChild(option);
            });

            currentAgent = agents[0].handle;
            sendBtn.disabled = false;
        }

        // Load session list
        async function loadSessions() {
            try {
                const response = await fetchWithAuth('/sessions');
                if (!response.ok) {
                    sessionList.innerHTML = '<div class="session-item"><span class="title">No sessions</span></div>';
                    return;
                }
                
                const sessions = await response.json();
                renderSessions(sessions);
            } catch (err) {
                console.error('Failed to load sessions:', err);
            }
        }

        // Render session list
        function renderSessions(sessions) {
            if (!sessions || sessions.length === 0) {
                sessionList.innerHTML = '<div class="session-item"><span class="title">No sessions yet</span></div>';
                return;
            }

            sessionList.innerHTML = sessions.map(session => `
                <div class="session-item ${session.id === currentSessionId ? 'active' : ''}" 
                     data-id="${session.id}" onclick="loadSession('${session.id}')">
                    <div class="title">${escapeHtml(session.title || 'Untitled')}</div>
                    <div class="meta">${session.agent_handle} Â· ${formatDate(session.updated_at)}</div>
                </div>
            `).join('');
        }

        // Load a specific session
        async function loadSession(sessionId) {
            closeSidebar();
            
            try {
                const response = await fetchWithAuth(`/agents/${currentAgent}/sessions/${sessionId}`);
                if (!response.ok) throw new Error('Failed to load session');
                
                const session = await response.json();
                currentSessionId = sessionId;
                
                // Update sidebar selection
                document.querySelectorAll('.session-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.id === sessionId);
                });

                // Render messages
                renderSessionMessages(session.messages || []);
            } catch (err) {
                console.error('Failed to load session:', err);
            }
        }

        // Render session messages
        function renderSessionMessages(messages) {
            messagesContainer.innerHTML = '';
            emptyState.style.display = messages.length === 0 ? 'flex' : 'none';
            
            messages.forEach(msg => {
                if (msg.role === 'system') return;
                addMessage(msg.role, msg.content);
            });
            
            scrollToBottom();
        }

        // Start new session
        function startNewSession() {
            currentSessionId = null;
            messagesContainer.innerHTML = '';
            emptyState.style.display = 'flex';
            document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
        }

        // Agent change handler
        function onAgentChange() {
            currentAgent = agentSelect.value;
            startNewSession();
        }

        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentAgent || isStreaming) return;

            messageInput.value = '';
            autoResizeInput();
            emptyState.style.display = 'none';

            // Add user message
            addMessage('user', message);

            // Create assistant message placeholder
            const assistantDiv = addMessage('assistant', '');
            const contentDiv = assistantDiv.querySelector('.message-content');
            contentDiv.innerHTML = '<div class="streaming-indicator"><span></span><span></span><span></span></div>';

            isStreaming = true;
            sendBtn.disabled = true;

            try {
                const endpoint = currentSessionId 
                    ? `/agents/${currentAgent}/sessions/${currentSessionId}`
                    : `/agents/${currentAgent}/chat`;

                const response = await fetchWithAuth(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                // Handle SSE response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let responseText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7);
                        } else if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleSSEEvent(currentEvent, data, contentDiv, assistantDiv);
                                
                                if (currentEvent === 'text_delta') {
                                    responseText += data.delta;
                                } else if (currentEvent === 'done') {
                                    currentSessionId = data.session_id;
                                    loadSessions();
                                }
                            } catch (e) {}
                        }
                    }
                }

                // Final render
                if (responseText) {
                    contentDiv.innerHTML = renderMarkdown(responseText);
                }

            } catch (err) {
                contentDiv.innerHTML = `<span style="color: var(--error)">Error: ${escapeHtml(err.message)}</span>`;
            } finally {
                isStreaming = false;
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Handle SSE events
        let currentEvent = '';
        let streamingText = '';
        let toolCalls = new Map();

        function handleSSEEvent(event, data, contentDiv, assistantDiv) {
            switch (event) {
                case 'text_delta':
                    streamingText += data.delta;
                    contentDiv.innerHTML = renderMarkdown(streamingText);
                    scrollToBottom();
                    break;

                case 'text_done':
                    streamingText = '';
                    break;

                case 'tool_start':
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'tool-call';
                    toolDiv.id = `tool-${data.id}`;
                    toolDiv.innerHTML = `
                        <div class="tool-header">
                            <span class="status-icon pending">...</span>
                            <span class="name">${escapeHtml(data.name)}</span>
                            <span class="description">${escapeHtml(data.description || '')}</span>
                        </div>
                        <div class="tool-body">${data.command ? escapeHtml(data.command) : ''}</div>
                    `;
                    assistantDiv.appendChild(toolDiv);
                    toolCalls.set(data.id, toolDiv);
                    scrollToBottom();
                    break;

                case 'tool_result':
                    const existingTool = toolCalls.get(data.id);
                    if (existingTool) {
                        const header = existingTool.querySelector('.tool-header');
                        const body = existingTool.querySelector('.tool-body');
                        const statusIcon = header.querySelector('.status-icon');
                        
                        const isError = !!data.error;
                        statusIcon.textContent = isError ? 'x' : 'ok';
                        statusIcon.className = `status-icon ${isError ? 'error' : 'success'}`;
                        
                        const durationSpan = document.createElement('span');
                        durationSpan.className = 'duration';
                        durationSpan.textContent = `${data.duration_ms}ms`;
                        header.appendChild(durationSpan);
                        
                        body.textContent = isError ? data.error : (data.output || '(no output)');
                        if (isError) body.classList.add('error');
                    }
                    scrollToBottom();
                    break;

                case 'reasoning_delta':
                    let reasoningDiv = assistantDiv.querySelector('.reasoning');
                    if (!reasoningDiv) {
                        reasoningDiv = document.createElement('div');
                        reasoningDiv.className = 'reasoning';
                        reasoningDiv.innerHTML = `
                            <div class="reasoning-header" onclick="this.parentElement.classList.toggle('expanded')">
                                <span>Thinking...</span>
                            </div>
                            <div class="reasoning-content"></div>
                        `;
                        assistantDiv.insertBefore(reasoningDiv, contentDiv.nextSibling);
                    }
                    const reasoningContent = reasoningDiv.querySelector('.reasoning-content');
                    reasoningContent.textContent += data.delta;
                    break;

                case 'error':
                    contentDiv.innerHTML = `<span style="color: var(--error)">Error: ${escapeHtml(data.message)}</span>`;
                    break;
            }
        }

        // Add message to chat
        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<div class="message-content">${role === 'user' ? escapeHtml(content) : renderMarkdown(content)}</div>`;
            messagesContainer.appendChild(div);
            scrollToBottom();
            return div;
        }

        // Simple markdown renderer
        function renderMarkdown(text) {
            if (!text) return '';
            
            // Escape HTML first
            let html = escapeHtml(text);
            
            // Code blocks
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            return date.toLocaleDateString();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function setStatus(status, text) {
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        function onInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResizeInput() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        // Start
        checkSavedConnection();
    </script>
</body>
</html>
